<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0065A3" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Dictionnaire Patois de Termignon</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bleu:        #0065A3;   /* RAL 5017 */
      --bleu-clair:  #0078c0;
      --bleu-fonce:  #004f80;
      --accent:      #e8a020;   /* accent chaud sobre */
      --creme:       #f4f7fb;
      --gris-clair:  #f0f4f8;
      --brun:        #1a2a3a;
      --brun-light:  #4a6070;
      --blanc:       #ffffff;
      --strip-pair:  #ffffff;
      --strip-impair:#f3f7fb;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Lato', sans-serif;
      background-color: var(--creme);
      color: var(--brun);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      background: var(--bleu);
      padding: 1.4rem 1.2rem 1rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    header::before {
      content: '';
      position: absolute; inset: 0;
      background: repeating-linear-gradient(
        45deg, transparent, transparent 18px,
        rgba(255,255,255,0.04) 18px, rgba(255,255,255,0.04) 19px
      );
    }
    header h1 {
      font-family: 'Playfair Display', serif;
      color: #ffffff;
      font-size: 1.55rem;
      letter-spacing: 0.03em;
      position: relative;
    }
    header p {
      color: rgba(255,255,255,0.72);
      font-size: 0.74rem;
      margin-top: 0.25rem;
      font-weight: 300;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      position: relative;
    }

    /* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
    #load-status {
      margin: 0.55rem 1rem 0;
      font-size: 0.76rem;
      min-height: 1.1rem;
      color: var(--brun-light);
      text-align: center;
    }
    #load-status.ok  { color: #1a7a3a; font-weight: 700; }
    #load-status.err { color: #c0392b; font-weight: 700; }

    /* ‚îÄ‚îÄ DIRECTION ‚îÄ‚îÄ */
    #direction-toggle {
      margin: 0.7rem 1rem 0;
      display: flex;
      background: var(--blanc);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,101,163,0.10);
    }
    .dir-btn {
      flex: 1;
      padding: 0.7rem 0.4rem;
      border: none;
      background: transparent;
      cursor: pointer;
      font-family: 'Lato', sans-serif;
      font-size: 0.76rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: var(--brun-light);
      transition: all 0.22s;
    }
    .dir-btn.active { background: var(--bleu); color: #ffffff; }
    .dir-btn span { display: block; font-size: 0.63rem; font-weight: 300; opacity: 0.82; margin-top: 2px; }

    /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
    #view-tabs {
      margin: 0.7rem 1rem 0;
      display: flex;
      gap: 0.35rem;
    }
    .tab-btn {
      flex: 1;
      padding: 0.52rem 0.3rem;
      border: 2px solid #d0dce8;
      border-radius: 8px;
      background: var(--blanc);
      cursor: pointer;
      font-family: 'Lato', sans-serif;
      font-size: 0.74rem;
      font-weight: 700;
      color: var(--brun-light);
      transition: all 0.2s;
      white-space: nowrap;
    }
    .tab-btn.active { border-color: var(--bleu); background: var(--bleu); color: #ffffff; }

    /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
    #search-zone {
      margin: 0.7rem 1rem 0;
      position: relative;
    }
    #search-input {
      width: 100%;
      padding: 0.82rem 1rem 0.82rem 2.7rem;
      border: 2px solid #d0dce8;
      border-radius: 10px;
      font-size: 0.97rem;
      font-family: 'Lato', sans-serif;
      background: var(--blanc);
      color: var(--brun);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    #search-input:focus {
      outline: none;
      border-color: var(--bleu-clair);
      box-shadow: 0 0 0 3px rgba(0,101,163,0.12);
    }
    .search-icon {
      position: absolute; left: 0.88rem; top: 50%;
      transform: translateY(-50%);
      font-size: 1.05rem; pointer-events: none;
    }
    #result-count {
      font-size: 0.73rem; color: var(--brun-light);
      margin: 0.38rem 0 0 1.1rem; min-height: 1rem;
    }

    /* ‚îÄ‚îÄ SEARCH CARDS ‚îÄ‚îÄ */
    #results {
      margin: 0.5rem 1rem 1rem;
      display: flex; flex-direction: column; gap: 0.4rem;
    }
    .card {
      background: var(--blanc);
      border-radius: 9px;
      padding: 0.8rem 1rem;
      box-shadow: 0 1px 6px rgba(0,101,163,0.07);
      display: flex; align-items: flex-start; gap: 0.75rem;
      animation: fadeUp 0.16s ease both;
      border-left: 3px solid transparent;
      transition: border-color 0.18s, box-shadow 0.18s;
    }
    .card:hover { border-left-color: var(--accent); box-shadow: 0 4px 14px rgba(0,101,163,0.13); }
    @keyframes fadeUp {
      from { opacity:0; transform:translateY(5px); }
      to   { opacity:1; transform:translateY(0); }
    }
    .card-arrow { font-size: 1rem; margin-top: 3px; flex-shrink: 0; color: var(--accent); }
    .card-body  { flex: 1; }
    .card-source {
      font-family: 'Playfair Display', serif;
      font-size: 1rem; font-weight: 700; color: var(--brun);
    }
    .card-source mark {
      background: rgba(232,160,32,0.25); border-radius: 2px; color: inherit;
    }
    .card-target { font-size: 0.86rem; color: var(--brun-light); margin-top: 2px; font-style: italic; }
    .card-lang {
      font-size: 0.6rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.08em; color: var(--bleu);
      background: rgba(0,101,163,0.09); border-radius: 4px;
      padding: 2px 6px; align-self: flex-start; flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ ACCORDION DICTIONNAIRE ‚îÄ‚îÄ */
    #browse-zone {
      margin: 0.5rem 1rem 2rem;
      display: none;
    }
    .letter-group { margin-bottom: 0.38rem; }

    .letter-header {
      display: flex; align-items: center;
      background: var(--bleu); color: #ffffff;
      border-radius: 8px; padding: 0.62rem 1rem;
      cursor: pointer; user-select: none;
      transition: background 0.18s;
    }
    .letter-header:hover  { background: var(--bleu-clair); }
    .letter-header.open   { border-radius: 8px 8px 0 0; background: var(--bleu-clair); }

    .letter-badge {
      font-family: 'Playfair Display', serif;
      font-size: 1.2rem; font-weight: 700;
      width: 1.8rem; text-align: center;
    }
    .letter-label {
      flex: 1; font-size: 0.76rem; font-weight: 700;
      letter-spacing: 0.04em; margin-left: 0.7rem; opacity: 0.88;
    }
    .letter-chevron { font-size: 0.72rem; transition: transform 0.22s; }
    .letter-header.open .letter-chevron { transform: rotate(180deg); }

    .letter-body {
      display: none;
      border-radius: 0 0 8px 8px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,101,163,0.08);
    }
    .letter-body.open { display: block; }

    /* Lignes altern√©es blanc / gris tr√®s clair */
    .browse-row {
      display: flex; align-items: center;
      padding: 0.55rem 1rem;
      gap: 0.7rem;
      transition: background 0.1s;
    }
    .browse-row:nth-child(odd)  { background: var(--strip-pair); }
    .browse-row:nth-child(even) { background: var(--strip-impair); }
    .browse-row:hover { background: rgba(0,101,163,0.06) !important; }

    .browse-src {
      font-family: 'Playfair Display', serif;
      font-size: 0.93rem; font-weight: 700; color: var(--brun);
      min-width: 42%;
    }
    .browse-arrow { color: var(--accent); font-size: 0.83rem; flex-shrink: 0; }
    .browse-tgt   { font-size: 0.84rem; color: var(--brun-light); font-style: italic; }

    /* ‚îÄ‚îÄ GRAMMAIRE ‚îÄ‚îÄ */
    .gram-group { margin-bottom: 0.38rem; }

    .gram-header {
      display: flex; align-items: center;
      background: var(--bleu); color: #ffffff;
      border-radius: 8px; padding: 0.65rem 1rem;
      cursor: pointer; user-select: none;
      transition: background 0.18s;
    }
    .gram-header:hover { background: var(--bleu-clair); }
    .gram-header.open  { border-radius: 8px 8px 0 0; background: var(--bleu-clair); }

    .gram-titre {
      flex: 1;
      font-family: 'Playfair Display', serif;
      font-size: 0.97rem; font-weight: 700;
    }
    .gram-count  { font-size: 0.7rem; opacity: 0.7; margin-right: 0.6rem; }
    .gram-chevron { font-size: 0.72rem; transition: transform 0.22s; }
    .gram-header.open .gram-chevron { transform: rotate(180deg); }

    .gram-body {
      display: none;
      border-radius: 0 0 8px 8px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,101,163,0.08);
    }
    .gram-body.open { display: block; }

    .gram-row {
      display: flex; align-items: center;
      padding: 0.55rem 1rem; gap: 0.7rem;
      transition: background 0.1s;
    }
    .gram-row:nth-child(odd)  { background: var(--strip-pair); }
    .gram-row:nth-child(even) { background: var(--strip-impair); }
    .gram-row:hover { background: rgba(0,101,163,0.06) !important; }

    .gram-src {
      font-size: 0.93rem; font-weight: 700;
      color: var(--brun); min-width: 42%;
    }
    .gram-arrow { color: var(--accent); font-size: 0.83rem; flex-shrink: 0; }
    .gram-tgt   { font-size: 0.86rem; color: var(--brun-light); font-style: italic; }

    /* ‚îÄ‚îÄ EXPRESSIONS ‚îÄ‚îÄ */
    #expressions-zone {
      margin: 0.5rem 1rem 2rem;
      display: none;
    }
    .expr-list { border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,101,163,0.08); }

    .expr-row {
      display: flex; align-items: flex-start;
      padding: 0.7rem 1rem; gap: 0.7rem;
      transition: background 0.1s;
    }
    .expr-row:nth-child(odd)  { background: var(--strip-pair); }
    .expr-row:nth-child(even) { background: var(--strip-impair); }
    .expr-row:hover { background: rgba(0,101,163,0.06) !important; }

    .expr-src {
      flex: 1; font-size: 0.92rem; font-weight: 700;
      font-family: 'Playfair Display', serif; color: var(--brun);
    }
    .expr-src mark { background: rgba(232,160,32,0.25); border-radius: 2px; color: inherit; }
    .expr-arrow { color: var(--accent); font-size: 0.83rem; flex-shrink: 0; padding-top: 3px; }
    .expr-tgt { flex: 1; font-size: 0.86rem; color: var(--brun-light); font-style: italic; }

    #expr-search-zone {
      margin: 0.7rem 1rem 0;
      position: relative;
    }
    #expr-search-input {
      width: 100%;
      padding: 0.82rem 1rem 0.82rem 2.7rem;
      border: 2px solid #d0dce8;
      border-radius: 10px;
      font-size: 0.97rem;
      font-family: 'Lato', sans-serif;
      background: var(--blanc);
      color: var(--brun);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    #expr-search-input:focus {
      outline: none;
      border-color: var(--bleu-clair);
      box-shadow: 0 0 0 3px rgba(0,101,163,0.12);
    }
    #expr-count {
      font-size: 0.73rem; color: var(--brun-light);
      margin: 0.38rem 0 0.5rem 1.1rem; min-height: 1rem;
    }

    /* ‚îÄ‚îÄ EMPTY / LOADING ‚îÄ‚îÄ */
    .empty-state {
      text-align: center; padding: 2.5rem 1rem; color: var(--brun-light);
    }
    .empty-state .icon { font-size: 2.4rem; margin-bottom: 0.5rem; }
    .empty-state p { font-size: 0.86rem; line-height: 1.6; }

    /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
    #stats-bar {
      text-align: center; padding: 0.4rem 1rem 1.5rem;
      font-size: 0.68rem; color: rgba(26,42,58,0.35); letter-spacing: 0.05em;
    }
  </style>
</head>
<body>

<header>
  <h1>Dictionnaire Patois de Termignon</h1>
  <p>Fran√ßais ‚Üî Patois de Termignon</p>
</header>

<div id="load-status"></div>

<!-- DIRECTION -->
<div id="direction-toggle">
  <button class="dir-btn active" id="btn-fr" onclick="setDir('fr')">
    Fran√ßais ‚Üí Patois de Termignon
    <span>Chercher en fran√ßais</span>
  </button>
  <button class="dir-btn" id="btn-pa" onclick="setDir('pa')">
    Patois de Termignon ‚Üí Fran√ßais
    <span>Chercher en patois</span>
  </button>
</div>

<!-- TABS -->
<div id="view-tabs">
  <button class="tab-btn active"  id="tab-search"      onclick="setTab('search')">üîç Recherche</button>
  <button class="tab-btn"         id="tab-browse"      onclick="setTab('browse')">üìñ Dictionnaire</button>
  <button class="tab-btn"         id="tab-grammaire"   onclick="setTab('grammaire')">üìù Grammaire</button>
  <button class="tab-btn"         id="tab-expressions" onclick="setTab('expressions')">üí¨ Expressions</button>
</div>

<!-- ‚îÄ‚îÄ RECHERCHE ‚îÄ‚îÄ -->
<div id="search-zone">
  <span class="search-icon">üîç</span>
  <input type="search" id="search-input" placeholder="Tapez un mot en fran√ßais‚Ä¶" oninput="doSearch()" />
</div>
<div id="result-count"></div>
<div id="results">
  <div class="empty-state"><div class="icon">‚è≥</div><p>Chargement du dictionnaire‚Ä¶</p></div>
</div>

<!-- ‚îÄ‚îÄ DICTIONNAIRE (accordion par lettre) ‚îÄ‚îÄ -->
<div id="browse-zone"></div>

<!-- ‚îÄ‚îÄ GRAMMAIRE ‚îÄ‚îÄ -->
<div id="grammaire-zone" style="margin:0.5rem 1rem 2rem; display:none;"></div>

<!-- ‚îÄ‚îÄ EXPRESSIONS ‚îÄ‚îÄ -->
<div id="expressions-zone">
  <div id="expr-search-zone" style="margin-top:0.7rem">
    <span class="search-icon" style="left:1.85rem">üîç</span>
    <input type="search" id="expr-search-input" placeholder="Rechercher une expression‚Ä¶" oninput="doExprSearch()" />
  </div>
  <div id="expr-count"></div>
  <div id="expr-list"></div>
</div>

<div id="stats-bar"></div>

<script>
  // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  // ‚ïë  CONFIGUREZ ICI VOS LIENS GOOGLE SHEETS             ‚ïë
  // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  const SHEET_DICO        = 'https://docs.google.com/spreadsheets/d/1_3mqc7SEnCo_7LywBkragMgukzZ9M8NT7YKMski3wSM/export?format=csv&gid=0';
  const SHEET_EXPRESSIONS = 'https://docs.google.com/spreadsheets/d/1_3mqc7SEnCo_7LywBkragMgukzZ9M8NT7YKMski3wSM/export?format=csv&gid=1734011386';
  const SHEET_GRAMMAIRE   = 'https://docs.google.com/spreadsheets/d/1_3mqc7SEnCo_7LywBkragMgukzZ9M8NT7YKMski3wSM/export?format=csv&gid=697526515';
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  let dictionary   = [];
  let expressions  = [];
  let grammaire    = [];
  let direction    = 'fr';
  let currentTab   = 'search';
  let openLetters  = new Set();
  let openGrammaire = new Set();

  // ‚îÄ‚îÄ D√©marrage ‚îÄ‚îÄ
  window.addEventListener('load', () => {
    const hasDico = SHEET_DICO && SHEET_DICO !== 'VOTRE_LIEN_FEUILLE_DICTIONNAIRE';
    const hasExpr = SHEET_EXPRESSIONS && SHEET_EXPRESSIONS !== 'VOTRE_LIEN_FEUILLE_EXPRESSIONS';
    const hasGram = SHEET_GRAMMAIRE && SHEET_GRAMMAIRE !== 'VOTRE_LIEN_FEUILLE_GRAMMAIRE';

    if (hasDico) loadSheet(SHEET_DICO, 'dico');
    else { loadDemoDict(); }

    if (hasExpr) loadSheet(SHEET_EXPRESSIONS, 'expr');
    else { loadDemoExpr(); }

    if (hasGram) loadSheet(SHEET_GRAMMAIRE, 'gram');
    else { loadDemoGram(); }
  });

  // ‚îÄ‚îÄ Chargement Google Sheets ‚îÄ‚îÄ
  async function loadSheet(url, type) {
    setStatus('‚è≥ Chargement‚Ä¶', '');
    try {
      const proxy = 'https://corsproxy.io/?' + encodeURIComponent(url);
      const res = await fetch(proxy);
      if (!res.ok) throw new Error('Acc√®s refus√©');
      const text = await res.text();
      parseCSV(text, type);
    } catch(e) {
      setStatus('‚ùå Erreur chargement ‚Äî donn√©es de d√©mo activ√©es', 'err');
      if (type === 'dico') loadDemoDict();
      else if (type === 'expr') loadDemoExpr();
      else loadDemoGram();
    }
  }

  function parseCSV(text, type) {
    const lines = text.trim().split('\n');
    const data  = [];
    const start = isHeader(lines[0]) ? 1 : 0;
    for (let i = start; i < lines.length; i++) {
      const cols = splitCSV(lines[i]);
      const fr = (cols[0]||'').trim();
      const pa = (cols[1]||'').trim();
      if (fr && pa) data.push({fr, pa});
    }
    if (type === 'dico') {
      dictionary = data.length ? data : demoDict();
      onDicoReady();
    } else if (type === 'expr') {
      expressions = data.length ? data : demoExpr();
      onExprReady();
    } else {
      // grammaire : col A = titre section, col B = texte fran√ßais, col C = texte patois
      const raw = [];
      const lines2 = text.trim().split('\n');
      const start2 = isHeader(lines2[0]) ? 1 : 0;
      for (let i = start2; i < lines2.length; i++) {
        const cols2 = splitCSV(lines2[i]);
        raw.push({ a: (cols2[0]||'').trim(), b: (cols2[1]||'').trim(), c: (cols2[2]||'').trim() });
      }
      grammaire = raw.length ? buildGrammaireSections(raw) : buildGrammaireSections(demoGramRaw());
      onGramReady();
    }
  }

  function loadDemoDict() { dictionary = demoDict(); onDicoReady(); }
  function loadDemoExpr() { expressions = demoExpr(); onExprReady(); }
  function loadDemoGram() { grammaire = buildGrammaireSections(demoGramRaw()); onGramReady(); }

  function demoDict() {
    return [
      {fr:'Arbre',pa:'√Çbre'},{fr:'Bonjour',pa:'Bondzo'},{fr:'Bonsoir',pa:'Bonsv√®i'},
      {fr:'Cheval',pa:'Chou√†'},{fr:'Eau',pa:'Ava'},{fr:'Enfant',pa:'Anfan'},
      {fr:'Feu',pa:'Fu√®'},{fr:'Fleur',pa:'Fleur'},{fr:'Fr√®re',pa:'Fr√™re'},
      {fr:'Jour',pa:'Dzor'},{fr:'Maison',pa:'M√®izon'},{fr:'Merci',pa:'Merci ben'},
      {fr:'Montagne',pa:'Montagne'},{fr:'M√®re',pa:'M√™re'},{fr:'Neige',pa:'N√®i'},
      {fr:'Nuit',pa:'Nu√®'},{fr:'Pain',pa:'Pan'},{fr:'P√®re',pa:'P√™re'},
      {fr:'Pierre',pa:'Pi√™re'},{fr:'Soleil',pa:'Sol√®i'},{fr:'S≈ìur',pa:'S≈ìr'},
      {fr:'Vent',pa:'Van'},{fr:'Vache',pa:'Vatse'},{fr:'Village',pa:'Vil√¢dzo'},
    ];
  }
  function demoExpr() {
    return [
      {fr:'Comment vas-tu ?',pa:'Coment que vas ?'},
      {fr:'Je ne sais pas.',pa:'Dz√® s√© pa.'},
      {fr:'Il fait beau aujourd\'hui.',pa:'F√© b√¥ odi√©r.'},
      {fr:'Bonne nuit !',pa:'Bona nu√® !'},
    ];
  }

  // Donn√©es brutes grammaire : col A = titre (non vide = nouvelle section), B = FR, C = patois
  function demoGramRaw() {
    return [
      {a:'Les articles d√©finis',  b:'le / la / les',          c:'lo / la / l√©'},
      {a:'',                      b:'le chien',               c:'lo tian'},
      {a:'',                      b:'la maison',              c:'la m√®izon'},
      {a:'',                      b:'les enfants',            c:'l√© anfans'},
      {a:'Les articles ind√©finis',b:'un / une / des',         c:'un / una / d√©'},
      {a:'',                      b:'un homme',               c:'un om√®'},
      {a:'',                      b:'une femme',              c:'una fena'},
      {a:'',                      b:'des fleurs',             c:'d√© fleurs'},
      {a:'Les pronoms personnels', b:'je / tu / il / elle',   c:'dz√® / tu / el / ela'},
      {a:'',                      b:'nous / vous / ils',      c:'no / vo / el'},
    ];
  }

  // Regroupe les lignes brutes en sections : chaque ligne avec col A non vide = titre de section
  function buildGrammaireSections(raw) {
    const sections = [];
    let current = null;
    raw.forEach(row => {
      if (row.a) {
        // Nouvelle section
        current = { titre: row.a, lignes: [] };
        if (row.b || row.c) current.lignes.push({ fr: row.b, pa: row.c });
        sections.push(current);
      } else if (current && (row.b || row.c)) {
        current.lignes.push({ fr: row.b, pa: row.c });
      }
    });
    return sections;
  }

  function onDicoReady() {
    updateStats();
    renderBrowse();
    doSearch();
    setStatus(`‚úÖ ${dictionary.length} mots charg√©s`, 'ok');
    setTimeout(() => setStatus('',''), 3500);
  }
  function onExprReady() {
    updateStats();
    doExprSearch();
  }
  function onGramReady() {
    updateStats();
    renderGrammaire();
  }

  function updateStats() {
    document.getElementById('stats-bar').textContent =
      `üìö ${dictionary.length} mot${dictionary.length>1?'s':''} ¬∑ ${expressions.length} expression${expressions.length>1?'s':''} ¬∑ ${grammaire.length} r√®gle${grammaire.length>1?'s':''} ¬∑ Patois de Termignon`;
  }

  // ‚îÄ‚îÄ CSV ‚îÄ‚îÄ
  function isHeader(line) {
    const l = line.toLowerCase();
    return l.includes('fran√ßais')||l.includes('french')||l.includes('patois')||l.includes('mot')||l.includes('expression');
  }
  function splitCSV(line) {
    const out=[]; let cur='', inQ=false;
    for (const ch of line) {
      if (ch==='"') { inQ=!inQ; }
      else if (ch===','&&!inQ) { out.push(cur); cur=''; }
      else cur+=ch;
    }
    out.push(cur); return out;
  }

  // ‚îÄ‚îÄ Direction ‚îÄ‚îÄ
  function setDir(d) {
    direction = d;
    document.getElementById('btn-fr').classList.toggle('active', d==='fr');
    document.getElementById('btn-pa').classList.toggle('active', d==='pa');
    document.getElementById('search-input').placeholder =
      d==='fr' ? 'Tapez un mot en fran√ßais‚Ä¶' : 'Tapez un mot en patois de Termignon‚Ä¶';
    document.getElementById('expr-search-input').placeholder =
      d==='fr' ? 'Rechercher une expression en fran√ßais‚Ä¶' : 'Rechercher une expression en patois‚Ä¶';
    openLetters.clear();
    openGrammaire.clear();
    renderBrowse();
    renderGrammaire();
    doSearch();
    doExprSearch();
  }

  // ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
  function setTab(tab) {
    currentTab = tab;
    ['search','browse','grammaire','expressions'].forEach(t => {
      document.getElementById('tab-'+t).classList.toggle('active', t===tab);
    });
    document.getElementById('search-zone').style.display       = tab==='search'      ? '' : 'none';
    document.getElementById('result-count').style.display      = tab==='search'      ? '' : 'none';
    document.getElementById('results').style.display           = tab==='search'      ? '' : 'none';
    document.getElementById('browse-zone').style.display       = tab==='browse'      ? 'block' : 'none';
    document.getElementById('grammaire-zone').style.display    = tab==='grammaire'   ? 'block' : 'none';
    document.getElementById('expressions-zone').style.display  = tab==='expressions' ? 'block' : 'none';
  }

  // ‚îÄ‚îÄ Recherche dictionnaire ‚îÄ‚îÄ
  function doSearch() {
    const q   = document.getElementById('search-input').value.trim().toLowerCase();
    const box = document.getElementById('results');
    const cnt = document.getElementById('result-count');
    if (!dictionary.length) return;

    let list = q
      ? dictionary.filter(e => (direction==='fr'?e.fr:e.pa).toLowerCase().includes(q))
      : [...dictionary];

    list.sort((a,b) => {
      const wa=(direction==='fr'?a.fr:a.pa), wb=(direction==='fr'?b.fr:b.pa);
      if (q) {
        const as=wa.toLowerCase().startsWith(q), bs=wb.toLowerCase().startsWith(q);
        if (as&&!bs) return -1; if (!as&&bs) return 1;
      }
      return wa.localeCompare(wb,'fr');
    });

    const show = list.slice(0,100);
    if (!show.length) {
      box.innerHTML = `<div class="empty-state"><div class="icon">üîé</div><p>Aucun mot trouv√©.</p></div>`;
      cnt.textContent = 'Aucun r√©sultat'; return;
    }
    box.innerHTML = show.map((e,i) => {
      const src=direction==='fr'?e.fr:e.pa, tgt=direction==='fr'?e.pa:e.fr;
      const lbl=direction==='fr'?'FR':'PA';
      const hi=q?hl(src,q):src;
      return `<div class="card" style="animation-delay:${Math.min(i*0.018,0.3)}s">
        <div class="card-arrow">‚Üí</div>
        <div class="card-body">
          <div class="card-source">${hi}</div>
          <div class="card-target">${tgt}</div>
        </div>
        <div class="card-lang">${lbl}</div>
      </div>`;
    }).join('');
    cnt.textContent = q
      ? `${list.length} r√©sultat${list.length>1?'s':''}${list.length>100?' (100 affich√©s)':''}`
      : `${list.length} mot${list.length>1?'s':''} ‚Äî tapez pour filtrer`;
  }

  // ‚îÄ‚îÄ Accordion Dictionnaire ‚îÄ‚îÄ
  function renderBrowse() {
    const zone = document.getElementById('browse-zone');
    if (!dictionary.length) return;
    const sorted = [...dictionary].sort((a,b)=>{
      const wa=direction==='fr'?a.fr:a.pa, wb=direction==='fr'?b.fr:b.pa;
      return wa.localeCompare(wb,'fr');
    });
    const groups = {};
    sorted.forEach(e => {
      const word = direction==='fr'?e.fr:e.pa;
      const l = word[0].toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      if (!groups[l]) groups[l]=[];
      groups[l].push(e);
    });
    const letters = Object.keys(groups).sort();
    zone.innerHTML = letters.map(l => {
      const entries=groups[l], open=openLetters.has(l);
      return `<div class="letter-group">
        <div class="letter-header${open?' open':''}" onclick="toggleLetter('${l}')">
          <div class="letter-badge">${l}</div>
          <div class="letter-label">${entries.length} mot${entries.length>1?'s':''}</div>
          <div class="letter-chevron">‚ñº</div>
        </div>
        <div class="letter-body${open?' open':''}" id="lb-${l}">
          ${entries.map(e=>{
            const src=direction==='fr'?e.fr:e.pa, tgt=direction==='fr'?e.pa:e.fr;
            return `<div class="browse-row">
              <div class="browse-src">${src}</div>
              <div class="browse-arrow">‚Üí</div>
              <div class="browse-tgt">${tgt}</div>
            </div>`;
          }).join('')}
        </div>
      </div>`;
    }).join('');
  }

  function toggleLetter(l) {
    openLetters.has(l) ? openLetters.delete(l) : openLetters.add(l);
    const body=document.getElementById('lb-'+l), header=body.previousElementSibling;
    const open=openLetters.has(l);
    body.classList.toggle('open',open); header.classList.toggle('open',open);
  }

  // ‚îÄ‚îÄ Expressions ‚îÄ‚îÄ
  function doExprSearch() {
    const q   = document.getElementById('expr-search-input').value.trim().toLowerCase();
    const box = document.getElementById('expr-list');
    const cnt = document.getElementById('expr-count');
    if (!expressions.length) { box.innerHTML='<div class="empty-state"><div class="icon">‚è≥</div><p>Chargement‚Ä¶</p></div>'; return; }

    let list = q
      ? expressions.filter(e => (direction==='fr'?e.fr:e.pa).toLowerCase().includes(q))
      : [...expressions];

    if (!list.length) {
      box.innerHTML='<div class="empty-state"><div class="icon">üîé</div><p>Aucune expression trouv√©e.</p></div>';
      cnt.textContent='Aucun r√©sultat'; return;
    }

    box.innerHTML = `<div class="expr-list">${list.map(e=>{
      const src=direction==='fr'?e.fr:e.pa, tgt=direction==='fr'?e.pa:e.fr;
      const hi=q?hl(src,q):src;
      return `<div class="expr-row">
        <div class="expr-src">${hi}</div>
        <div class="expr-arrow">‚Üí</div>
        <div class="expr-tgt">${tgt}</div>
      </div>`;
    }).join('')}</div>`;

    cnt.textContent = `${list.length} expression${list.length>1?'s':''}${q?' trouv√©e'+( list.length>1?'s':''):''}`;
  }

  // ‚îÄ‚îÄ Grammaire ‚îÄ‚îÄ
  function renderGrammaire() {
    const zone = document.getElementById('grammaire-zone');
    if (!grammaire.length) {
      zone.innerHTML = '<div class="empty-state"><div class="icon">‚è≥</div><p>Chargement‚Ä¶</p></div>';
      return;
    }
    zone.innerHTML = grammaire.map((section, idx) => {
      const open = openGrammaire.has(idx);
      const lignes = section.lignes.map((l, i) => {
        const src = direction==='fr' ? l.fr : l.pa;
        const tgt = direction==='fr' ? l.pa : l.fr;
        return `<div class="gram-row">
          <div class="gram-src">${src}</div>
          <div class="gram-arrow">‚Üí</div>
          <div class="gram-tgt">${tgt}</div>
        </div>`;
      }).join('');
      return `<div class="gram-group">
        <div class="gram-header${open?' open':''}" onclick="toggleGrammaire(${idx})">
          <div class="gram-titre">${section.titre}</div>
          <div class="gram-count">${section.lignes.length} exemple${section.lignes.length>1?'s':''}</div>
          <div class="gram-chevron">‚ñº</div>
        </div>
        <div class="gram-body${open?' open':''}" id="gb-${idx}">
          ${lignes}
        </div>
      </div>`;
    }).join('');
  }

  function toggleGrammaire(idx) {
    openGrammaire.has(idx) ? openGrammaire.delete(idx) : openGrammaire.add(idx);
    const body   = document.getElementById('gb-' + idx);
    const header = body.previousElementSibling;
    const open   = openGrammaire.has(idx);
    body.classList.toggle('open', open);
    header.classList.toggle('open', open);
  }

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  function hl(text, q) {
    const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
    return text.replace(re, '<mark>$1</mark>');
  }
  function setStatus(msg, cls) {
    const el=document.getElementById('load-status');
    el.textContent=msg; el.className=cls;
  }
</script>
</body>
</html>
